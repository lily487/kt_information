name: Auto Tweet

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"   # UTC 0:00 = JST 9:00

jobs:
  tweet:
    runs-on: ubuntu-latest
    
    # 書き込み権限を明示的に付与
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set timezone to JST
        run: |
          sudo ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
          echo "Asia/Tokyo" | sudo tee /etc/timezone

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Build C program
        run: gcc teisyutsu2.c -o make_tweet

      - name: Generate today's info_tweet.txt
        run: ./make_tweet

      # --- 追加：生成されたファイルをリポジトリに保存（プッシュ）する ---
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update info_tweet.txt [skip ci]"
          file_pattern: 'info_tweet.txt'
      # ----------------------------------------------------------

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install tweepy

      - name: Run tweet script
        env:
          APIKEY: ${{ secrets.APIKEY }}
          APIKEYSECRET: ${{ secrets.APIKEYSECRET }}
          ACCESSTOKEN: ${{ secrets.ACCESSTOKEN }}
          ACCESSTOKENSECRET: ${{ secrets.ACCESSTOKENSECRET }}
        run: python kt_tweet.py